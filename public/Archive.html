<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="preconnect" href="http://localhost:5000/api/list">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="css/style.css" />
    <title>TABS Archive</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" href="icons/logo1.WebP" />

</head>

<body>
    <main>
        <nav>
            <img src="images\logo.WebP" alt="TABS logo" />
            <h1>TABS - Archive</h1>
            <ul class="topnav">
                <li><a href="index.html">Home</a></li>
                <li><a href="manage.html">Manage</a></li>
                <li><a href="#">Archive</a></li>
                <li><a href="music.html">Music</a></li>
            </ul>
        </nav>
        <div class="about-container">
            <p>
                Welcome to the archive as discussed before on the homepage, this page serves two purposes
            </p>

            <p>
                the first bar under this text is the archive list, which when dropped down by clicking shows all the factions on the left and the units on the right, if something is not appearing try clicking the refresh button.
            </p>
        </div>

        <details class="data-viewer">
            <summary class="data-summary">
                <div>
                    <h2>Archive</h2>
                    <p2>Click this bar to see all units currently stored in the database.</p2>
                </div>
                <span class="chevron" aria-hidden="true">▼</span>
            </summary>
            <div class="data-actions">
                <button id="refreshData">Refresh Data</button>
                <span id="dataStatus" aria-live="polite"></span>
            </div>
            <div class="data-grid">
                <div class="data-card">
                    <h3>Factions</h3>
                    <div class="table-wrapper">
                        <table id="factionTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Theme</th>
                                </tr>
                            </thead>
                            <tbody id="factionBody">
                                <tr><td colspan="2">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="data-card">
                    <h3>Units</h3>
                    <div class="table-wrapper">
                        <table id="unitTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Cost</th>
                                    <th>Health</th>
                                    <th>Speed</th>
                                </tr>
                            </thead>
                            <tbody id="unitBody">
                                <tr><td colspan="4">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </details>

        <div class="about-container">
            <p>
                This is the faction management tool (located below), here you can use the drop down option named "Factions:" to select which faction you wish to add or remove units from.
                Below that displays all the units currently inside the faction, and the right column displays which units are avalable to be added to the faction (units that are not in the faciton).
                Now lastly in the centre are the remove and add buttons.
            </br>
                How to use this tool:
                </br>
                1. Select the faction
                </br>
                2. select the unit
                </br>
                   - if you wish to add a unit use the right coloumn 
                   </br>
                   - if you wish to remove use the left coloumn 
                   </br>
                3. Select the respctive button to remove or add units!
            </p>
        </div>

        <section class="assign-viewer">
            <h2>Faction Management</h2>
            <p>Add or Remove units from factions using the buttons respectively</p>
            <div class="assign-controls">
                <label for="factionSelect">Factions:</label>
                <select id="factionSelect"></select>
                <span id="assignStatus" aria-live="polite"></span>
            </div>
            <div class="assign-grid">
                <div class="assign-card">
                    <h3>Units in Faction</h3>
                    <select id="assignedUnits" size="8"></select>
                </div>
                <div class="assign-actions">
                    <button id="removeUnitBtn">Remove</button>
                    <button id="addUnitBtn">Add</button>
                </div>
                <div class="assign-card">
                    <h3>Available Units</h3>
                    <select id="availableUnits" size="8"></select>
                </div>
            </div>
        </section>

    </main>

    <style>
        .data-viewer {
            margin: 2rem auto;
            padding: 1.5rem;
            max-width: 1100px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            background-image: url('images/NavBG1.jpg'); 
            background-repeat: no-repeat; 
            background-size: cover; 
            background-position: center; 
        }
        .data-viewer summary {
            cursor: pointer;
            list-style: none;
        }
        .data-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .data-summary h2 {
            margin: 0;
        }
        .data-summary p {
            margin: 0.25rem 0 0 0;
        }
        .data-viewer .chevron {
            font-size: 1.25rem;
            transition: transform 0.2s ease;
        }
        .data-viewer[open] .chevron {
            transform: rotate(0deg);
        }
        .data-viewer:not([open]) .chevron {
            transform: rotate(-90deg);
        }
        .data-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }
        .data-actions button {
            padding: 0.6rem 1.2rem;
            border: 1px solid whitesmoke;
            background: sandybrown;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1rem;
        }
        .data-card {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .table-wrapper {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #fafafa;
        }
        .empty {
            color: #777;
            font-style: italic;
        }
        .error {
            color: #c0392b;
            font-weight: bold;
        }
        .assign-viewer {
            margin: 2rem auto;
            padding: 1.5rem;
            max-width: 1100px;
            border-radius: 8px;
            background-image: url("images/NavBG1.jpg");
            background-repeat: no-repeat;
            background-size: cover;
            background-position-y: center;
            background-attachment:fixed;
        }
        .assign-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            background-color: white;
            padding-left: 5px;
            border-radius: 5px;
        }
        .assign-controls select {
            min-width: 220px;
            padding: 0.35rem;
        }
        .assign-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
        }
        .assign-card {
            background: sandybrown;
            border: 1px solid whitesmoke;
            border-radius: 6px;
            padding: 1rem;
        }
        
        .assign-card select {
            width: 100%;
            min-height: 240px;
        }
        .assign-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .assign-actions button {
            padding: 0.6rem 1rem;
            border: 1px solid whitesmoke;
            background: sandybrown;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>

    <script>
        const dataState = {
            factions: [],
            units: [],
            links: []
        };

        async function loadData() {
            const statusEl = document.getElementById('dataStatus');
            const factionBody = document.getElementById('factionBody');
            const unitBody = document.getElementById('unitBody');
            statusEl.textContent = 'Loading...';

            factionBody.innerHTML = '<tr><td colspan="2">Loading...</td></tr>';
            unitBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

            try {
                const response = await fetch('/api/list');
                if (!response.ok) {
                    throw new Error('Server responded with ' + response.status);
                }
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Failed to load data');
                }

                dataState.factions = result.factions || [];
                dataState.units = result.units || [];
                dataState.links = result.factionUnits || [];

                renderRows(factionBody, result.factions, ['Name', 'Theme']);
                renderRows(unitBody, result.units, ['Name', 'Cost', 'Health', 'Speed']);
                renderAssignments();
                statusEl.textContent = 'Showing latest data from the database.';
            } catch (err) {
                console.error(err);
                statusEl.innerHTML = '<span class="error">Could not load data.</span>';
                factionBody.innerHTML = '<tr><td colspan="2" class="error">Error loading factions.</td></tr>';
                unitBody.innerHTML = '<tr><td colspan="4" class="error">Error loading units.</td></tr>';
            }
        }

        function renderRows(tbody, rows, keys) {
            if (!rows || rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="' + keys.length + '" class="empty">No data yet.</td></tr>';
                return;
            }

            const html = rows.map(row => {
                const cells = keys.map(key => '<td>' + (row[key] ?? '') + '</td>').join('');
                return '<tr>' + cells + '</tr>';
            }).join('');

            tbody.innerHTML = html;
        }

        function renderAssignments() {
            const factionSelect = document.getElementById('factionSelect');
            const assignedSelect = document.getElementById('assignedUnits');
            const availableSelect = document.getElementById('availableUnits');
            const status = document.getElementById('assignStatus');

            if (!dataState.factions.length) {
                factionSelect.innerHTML = '<option value="">No factions yet</option>';
                assignedSelect.innerHTML = '';
                availableSelect.innerHTML = '';
                status.textContent = 'Add a faction to start assigning units.';
                return;
            }

            const currentValue = factionSelect.value;
            factionSelect.innerHTML = dataState.factions
                .map(f => `<option value="${f.FactionID}">${f.Name}</option>`)
                .join('');
            if (currentValue) factionSelect.value = currentValue;
            if (!factionSelect.value) factionSelect.value = dataState.factions[0].FactionID;

            const selectedFactionId = Number(factionSelect.value);
            const assigned = dataState.links.filter(l => l.FactionID === selectedFactionId);
            const assignedUnitIds = assigned.map(a => a.UnitID);

            assignedSelect.innerHTML = assigned.length
                ? assigned.map(a => `<option value="${a.UnitID}">${a.UnitName}</option>`).join('')
                : '<option disabled>No units assigned</option>';

            const available = dataState.units.filter(u => !assignedUnitIds.includes(u.UnitID));
            availableSelect.innerHTML = available.length
                ? available.map(u => `<option value="${u.UnitID}">${u.Name}</option>`).join('')
                : '<option disabled>All units assigned</option>';

            status.textContent = `Faction has ${assigned.length} unit(s).`;
        }

        async function updateLink(action) {
            const factionId = document.getElementById('factionSelect').value;
            const assignedSelect = document.getElementById('assignedUnits');
            const availableSelect = document.getElementById('availableUnits');
            const status = document.getElementById('assignStatus');

            const sourceSelect = action === 'add' ? availableSelect : assignedSelect;
            const selectedOption = sourceSelect.options[sourceSelect.selectedIndex];
            if (!selectedOption || selectedOption.disabled) {
                status.textContent = 'Select a unit first.';
                return;
            }

            const unitId = selectedOption.value;
            status.textContent = 'Saving...';

            try {
                const resp = await fetch('/api/faction-units', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ factionId, unitId, action })
                });
                const result = await resp.json();
                if (!resp.ok || !result.success) {
                    throw new Error(result.message || 'Request failed');
                }
                status.textContent = result.message;
                loadData();
            } catch (err) {
                console.error(err);
                status.textContent = 'Error: ' + err.message;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('refreshData').addEventListener('click', loadData);
            document.getElementById('factionSelect').addEventListener('change', renderAssignments);
            document.getElementById('addUnitBtn').addEventListener('click', () => updateLink('add'));
            document.getElementById('removeUnitBtn').addEventListener('click', () => updateLink('remove'));
            loadData();
        });
    </script>
    <div id="music-root-player">
      <div id="corner-player" class="corner-player" aria-hidden="false">
        <div class="cp-info">
          <div id="cp-title">No track selected</div>
          <div id="cp-controls">
            <button id="cp-prev" title="Previous">⏮</button>
            <button id="cp-play" title="Play/Pause">▶️</button>
            <button id="cp-next" title="Next">⏭</button>
			<a href="music.html" style="display:inline-block;padding:8px 12px;background-color:black;color:white;text-decoration:none; border-radius:4px;">
				Music
			</a>
          </div>
        </div>
        <audio autoplay id="global-audio" preload="metadata"></audio>
      </div>
    </div>
    <script src="js/music-player.js" defer></script>
</body>
</html>